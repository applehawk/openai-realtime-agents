# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å RAG –¥–ª—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–ª –æ —Å–≤–æ–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –º–æ–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è"), –∞–≥–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –æ–±—ã—á–Ω—ã–π `lightrag_query` –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è workspace —Å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—Ç–≤–µ—Ç—É "No relevant context found for the query", —Ç–∞–∫ –∫–∞–∫ –∞–≥–µ–Ω—Ç –∏—Å–∫–∞–ª –≤ –æ–±—â–µ–º workspace, –∞ –Ω–µ –≤ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–º workspace –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## üîç –ü—Ä–∏—á–∏–Ω–∞

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: –ê–≥–µ–Ω—Ç –Ω–µ —Ä–∞–∑–ª–∏—á–∞–ª –∑–∞–ø—Ä–æ—Å—ã –æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π. –î–ª—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π workspace `{userId}_user_key_preferences`, –∞ –Ω–µ –æ–±—â–∏–π workspace.

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**:
1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
2. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∞–≥–µ–Ω—Ç–∞ –Ω–µ —É–∫–∞–∑—ã–≤–∞–ª–∏ –Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ workspace
3. –ê–≥–µ–Ω—Ç –Ω–µ –ø–æ–Ω–∏–º–∞–ª, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π workspace

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π

–°–æ–∑–¥–∞–ª–∏ –Ω–æ–≤—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `queryUserPreferences` –≤ —Ñ–∞–π–ª–µ `userPreferencesTool.ts`:

```typescript
export const queryUserPreferences = tool({
  name: 'queryUserPreferences',
  description: '–ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ workspace',
  parameters: {
    type: 'object',
    properties: {
      userId: {
        type: 'string',
        description: 'ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
      },
      query: {
        type: 'string',
        description: '–ó–∞–ø—Ä–æ—Å –æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
      },
    },
    required: ['userId', 'query'],
    additionalProperties: false,
  },
  execute: async (input: any) => {
    const { userId, query } = input;
    
    try {
      const workspaceName = `${userId}_user_key_preferences`;
      
      // Call RAG API directly with user's workspace
      const response = await fetch('http://79.132.139.57:9621/query', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          query: query,
          mode: 'local',
          top_k: 3,
          workspace: workspaceName,
        }),
      });

      if (!response.ok) {
        throw new Error(`RAG API error: ${response.status}`);
      }

      const data = await response.json();
      
      return {
        success: true,
        response: data.response || '–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã',
        references: data.references || [],
        workspace: workspaceName,
      };
    } catch (error: any) {
      console.error('[UserPreferences] Error querying preferences:', error);
      return {
        success: false,
        response: `–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π: ${error.message}`,
        references: [],
        workspace: `${userId}_user_key_preferences`,
      };
    }
  },
});
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∞–≥–µ–Ω—Ç–∞

–î–æ–±–∞–≤–∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –≤ `index.ts`:

```typescript
**IMPORTANT**: When user asks about their preferences, personal settings, or interview data, the assistant MUST use queryUserPreferences tool with the real userId from getCurrentUserInfo, NOT the general lightrag_query tool. This ensures the assistant queries the user's personal workspace with their preferences.
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –≤ –∞–≥–µ–Ω—Ç–∞

–î–æ–±–∞–≤–∏–ª–∏ `queryUserPreferences` –≤ —Å–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∞–≥–µ–Ω—Ç–∞:

```typescript
tools: [
    // Primary MCP tools for direct email/calendar operations
    hostedMcpTool({
        serverLabel: 'calendar',
        serverUrl: 'https://rndaibot.app.n8n.cloud/mcp/google_my_account',
    }),
    // LightRAG tools for knowledge retrieval
    lightragQuery,
    lightragQueryData,
    // User info tool for getting current user information
    getCurrentUserInfo,
    // User preferences tool for querying personal preferences
    queryUserPreferences,
    // Interview tools for user personalization
    startInitialInterview,
    conductInitialInterview,
    checkInterviewStatus,
    // Supervisor delegation tool for complex multi-step tasks
    delegateToSupervisor,
],
```

## üîß –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

1. **–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç**: `queryUserPreferences` –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –∏–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ workspace
2. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π workspace**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `{userId}_user_key_preferences`
3. **–ß–µ—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏**: –ê–≥–µ–Ω—Ç –∑–Ω–∞–µ—Ç, –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
4. **–ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ RAG API**: –û–±—Ö–æ–¥–∏—Ç MCP —Å–µ—Ä–≤–µ—Ä –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π —Ä–∞–±–æ—Ç—ã

## üìã –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`src/app/agentConfigs/severstalAssistantAgent/userPreferencesTool.ts`** (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
   - –°–æ–∑–¥–∞–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `queryUserPreferences` –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π

2. **`src/app/agentConfigs/severstalAssistantAgent/index.ts`**
   - –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `queryUserPreferences`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
   - –î–æ–±–∞–≤–ª–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å:
- ‚úÖ –ê–≥–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π workspace –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–≤–æ–∏—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–µ–∂–¥—É –æ–±—â–∏–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º–∏
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
1. –ü—Ä–æ–π–¥–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤—å—é —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
2. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –≤ RAG
3. –°–ø—Ä–æ—Å–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞: "–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –º–æ–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è"
4. –ê–≥–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω:
   - –°–Ω–∞—á–∞–ª–∞ –≤—ã–∑–≤–∞—Ç—å `getCurrentUserInfo`
   - –ó–∞—Ç–µ–º –≤—ã–∑–≤–∞—Ç—å `queryUserPreferences` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º `userId`
   - –ù–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ workspace `{userId}_user_key_preferences`
   - –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è

## üîë –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

- **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `queryUserPreferences` –¥–ª—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
- **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π workspace**: –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `{userId}_user_key_preferences`
- **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**: –û–±—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã vs –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
- **–ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø**: –û–±—Ö–æ–¥ MCP —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

–ü—Ä–æ–±–ª–µ–º–∞ —Å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º —Å RAG –¥–ª—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞. –¢–µ–ø–µ—Ä—å –∞–≥–µ–Ω—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π workspace –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö.
