services:
  realtime-agents:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Only NEXT_PUBLIC_* vars need to be passed as build args
        # Server-side vars (AUTH_API_BASE, RAG_SERVER_URL, RAG_API_BASE_URL) are set at runtime
        - NEXT_PUBLIC_AUTH_API_URL=${NEXT_PUBLIC_AUTH_API_URL:-https://rndaibot.ru/apib/v1/}
    container_name: oma-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    env_file:
      - .env
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - DOCKER_ENV=true
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AUTH_API_BASE=${AUTH_API_BASE:-http://multiagent_app:7000/api/v1}
      - NEXT_PUBLIC_AUTH_API_URL=${NEXT_PUBLIC_AUTH_API_URL:-https://rndaibot.ru/apib/v1/}
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED:-0}
      - RAG_SERVER_URL=${RAG_SERVER_URL:-http://79.132.139.57:8000/mcp}
      - RAG_API_BASE_URL=${RAG_API_BASE_URL}
      - RAG_API_TIMEOUT=${RAG_API_TIMEOUT:-60000}
      - RAG_API_RETRY_ATTEMPTS=${RAG_API_RETRY_ATTEMPTS:-5}
      # RAG Health Check Configuration
      - RAG_HEALTH_CHECK_ENABLED=${RAG_HEALTH_CHECK_ENABLED:-true}
      - RAG_HEALTH_CHECK_TIMEOUT=${RAG_HEALTH_CHECK_TIMEOUT:-10000}
      - RAG_HEALTH_CHECK_RETRIES=${RAG_HEALTH_CHECK_RETRIES:-3}
      - RAG_HEALTH_CHECK_RETRY_DELAY=${RAG_HEALTH_CHECK_RETRY_DELAY:-1000}
      - NEXT_PUBLIC_RAG_HEALTH_CHECK_ENABLED=${NEXT_PUBLIC_RAG_HEALTH_CHECK_ENABLED:-true}
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - app-network
      - oma-network       # –æ–±—â–∞—è –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å oma-backend
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  app-network:
    driver: bridge
  oma-network:
    external: true  # üëà –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Ç—å