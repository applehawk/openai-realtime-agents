# Hierarchical Task Execution System

**Version:** 1.0
**Date:** 2025-10-22

---

## Обзор

Система иерархического выполнения задач позволяет **автоматически разбивать очень сложные задачи на подзадачи рекурсивно**, выполнять их в правильном порядке (с учётом зависимостей), собирать результаты иерархически и генерировать финальный отчёт.

### Зачем это нужно?

**Проблема:**
Пользователь может дать очень сложную задачу типа: *"Найди всех участников проекта Восток из переписки, проверь их календари на свободное время на следующей неделе, найди общее время когда все свободны, создай событие и отправь всем приглашения"*.

Эта задача содержит 8+ шагов, условную логику, множественные источники данных. Ни RealtimeAgent, ни обычный SupervisorAgent не справятся с ней эффективно в один запрос.

**Решение:**
1. SupervisorAgent **ПЛАНИРУЕТ** задачу, разбивая её на подзадачи (plannedSteps)
2. Система **РЕКУРСИВНО** разбивает каждую подзадачу на ещё более мелкие (если нужно)
3. Каждая листовая задача выполняется **НЕЗАВИСИМО** как отдельная задача
4. Результаты **СОБИРАЮТСЯ** иерархически снизу вверх
5. Генерируется **ФИНАЛЬНЫЙ ОТЧЁТ** со всеми деталями

---

## Архитектура

### Компоненты системы

```
┌─────────────────────────────────────────────────────────────┐
│                      User Request                            │
│           "Очень сложная задача с 8+ шагами"                │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                  RealtimeAgent                               │
│  Распознаёт очень сложную задачу                            │
│  → Вызывает executeComplexTask tool                         │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│             TaskOrchestrator (оркестратор)                  │
│                                                              │
│  1. Создаёт root task                                       │
│  2. Запускает рекурсивное разбиение                         │
│  3. Вычисляет порядок выполнения                            │
│  4. Выполняет задачи последовательно                        │
│  5. Собирает результаты                                      │
│  6. Генерирует отчёт                                         │
└────────────────────┬────────────────────────────────────────┘
                     │
         ┌───────────┴───────────┐
         ▼                       ▼
┌──────────────────┐    ┌──────────────────┐
│ SupervisorAgent  │    │ SupervisorAgent  │
│  (Breakdown)     │    │  (Execution)     │
│                  │    │                  │
│ Разбивает задачу │    │ Выполняет задачу │
│ на подзадачи     │    │ с tools (MCP,    │
│                  │    │ RAG, etc.)       │
└──────────────────┘    └──────────────────┘
         │                       │
         │                       │
         ▼                       ▼
┌─────────────────────────────────────────────────────────────┐
│                   Task Tree Structure                        │
│                                                              │
│  Root Task (сложная)                                        │
│    ├─ Subtask 1 (moderate)                                  │
│    │   ├─ Subtask 1.1 (simple) ✓                           │
│    │   └─ Subtask 1.2 (simple) ✓                           │
│    ├─ Subtask 2 (simple) ✓                                  │
│    └─ Subtask 3 (complex)                                   │
│        ├─ Subtask 3.1 (simple) ✓                           │
│        ├─ Subtask 3.2 (simple) ✓                           │
│        └─ Subtask 3.3 (simple) ✓                           │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│                     Final Report                             │
│  - Summary (краткое резюме)                                 │
│  - Detailed results (детали по каждой подзадаче)            │
│  - Hierarchical breakdown (структура для UI)                │
│  - Statistics (сколько задач выполнено/провалено)           │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│                  RealtimeAgent                               │
│  Озвучивает финальный отчёт пользователю                    │
└─────────────────────────────────────────────────────────────┘
```

---

## Типы данных

### Task (задача)

```typescript
interface Task {
  id: string;                    // "task-root", "task-root.0", "task-root.0.1", etc.
  parentId: string | null;       // ID родительской задачи
  description: string;           // Описание на русском
  complexity: TaskComplexity;    // "simple" | "moderate" | "complex"
  status: TaskStatus;            // "planned" | "in_progress" | "completed" | "failed" | "blocked"
  level: number;                 // Уровень вложенности (0 = root, 1 = subtask, etc.)

  // Результаты выполнения
  result?: string;               // Результат (после выполнения)
  error?: string;                // Ошибка (если провалено)
  executionStartTime?: Date;
  executionEndTime?: Date;

  // Иерархия
  subtasks: Task[];              // Подзадачи
  subtaskResults?: string[];     // Собранные результаты подзадач

  // Контекст и зависимости
  context?: Record<string, any>;
  dependencies?: string[];       // IDs задач, которые должны завершиться до этой
}
```

### TaskTree (дерево задач)

```typescript
interface TaskTree {
  rootTask: Task;                      // Корневая задача
  allTasks: Map<string, Task>;         // Плоская карта всех задач по ID
  executionOrder: string[];            // Порядок выполнения (только листовые задачи)
  currentTaskId: string | null;        // ID текущей выполняющейся задачи

  // Прогресс
  totalTasks: number;                  // Всего листовых задач
  completedTasks: number;              // Выполнено
  failedTasks: number;                 // Провалено

  // Контекст
  conversationHistory: string[];       // История беседы
}
```

---

## Рабочий процесс

### 1. Инициализация

```typescript
const orchestrator = new TaskOrchestrator({
  maxNestingLevel: 5,           // Максимум 5 уровней вложенности
  maxSubtasksPerTask: 10,       // Максимум 10 подзадач на задачу
  enableProgressCallbacks: true // Включить callbacks для UI
});
```

### 2. Запуск выполнения

```typescript
const report = await orchestrator.executeComplexTask(
  taskDescription,              // "Найди всех участников проекта..."
  conversationContext,          // Полная история беседы
  breakdownFn,                  // Функция разбиения (supervisor)
  executeFn,                    // Функция выполнения (supervisor/realtime)
  reportFn                      // Функция генерации отчёта
);
```

### 3. Рекурсивное разбиение

**Процесс:**

1. **Оценка сложности** - Supervisor анализирует задачу:
   - Простая (1 шаг, понятные параметры) → не разбивать
   - Средняя (2-4 шага) → не разбивать, выполнить сразу
   - Сложная (5+ шагов, условия, зависимости) → **РАЗБИТЬ**

2. **Создание подзадач** - Supervisor возвращает 2-10 подзадач:
   ```json
   {
     "shouldBreakdown": true,
     "subtasks": [
       {
         "description": "Выполню RAG запрос для поиска участников проекта",
         "estimatedComplexity": "simple"
       },
       {
         "description": "Проверю календари всех найденных участников",
         "estimatedComplexity": "moderate",
         "dependencies": [0]  // Зависит от задачи 0
       }
     ]
   }
   ```

3. **Рекурсия** - Каждая подзадача проверяется на сложность:
   - Если сложная → разбивается дальше
   - Если простая → остаётся листовой задачей (будет выполнена)

4. **Ограничения**:
   - Максимум 5 уровней вложенности
   - Максимум 10 подзадач на задачу
   - Предотвращает бесконечную рекурсию

### 4. Выполнение задач

**Порядок выполнения:**

```
Root Task (не выполняется напрямую)
  ├─ Subtask 1 → [Выполняется первой]
  │   ├─ 1.1 → [Выполняется первой]
  │   └─ 1.2 → [Выполняется второй]
  ├─ Subtask 2 → [Выполняется третьей]
  └─ Subtask 3 → [Выполняется четвёртой]
      ├─ 3.1 → [Выполняется после Subtask 2]
      └─ 3.2 → [Выполняется после 3.1]
```

**Depth-first execution:**
1. Выполняются **только листовые задачи** (без подзадач)
2. Порядок: depth-first (сначала вглубь, потом вширь)
3. **Зависимости учитываются** - задача не начнётся, пока зависимости не завершены
4. **Контекст передаётся** - каждая задача получает результаты предыдущих

### 5. Сбор результатов

**Иерархический сбор:**

```
Subtask 1.1 completed → result: "Нашёл 6 участников"
Subtask 1.2 completed → result: "Извлёк email-адреса"
  ↓
Subtask 1 collects results:
  result: "Нашёл 6 участников. Извлёк email-адреса."

Subtask 2 completed → result: "Проверил календари"
Subtask 3.1 completed → result: "Нашёл общее время"
Subtask 3.2 completed → result: "Создал событие"
  ↓
Subtask 3 collects results:
  result: "Нашёл общее время. Создал событие."
  ↓
Root Task collects all:
  result: "1. Нашёл 6 участников. Извлёк email-адреса.
          2. Проверил календари.
          3. Нашёл общее время. Создал событие."
```

### 6. Генерация отчёта

**Supervisor создаёт финальный отчёт:**

```json
{
  "summary": "Я организовал встречу со всеми участниками проекта 'Восток'.",
  "detailedResults": "Нашёл шесть участников: Иван, Анна, Пётр, Марина, Сергей и Ольга. Проверил их календари на следующую неделю и нашёл общее свободное время: среда пятнадцатого января в четырнадцать ноль-ноль. Создал событие на два часа и отправил приглашения всем участникам.",
  "tasksCompleted": 7,
  "tasksFailed": 0,
  "executionTime": 12500,
  "hierarchicalBreakdown": { /* структура для UI */ }
}
```

---

## Примеры использования

### Пример 1: Организация встречи команды

**User request:**
> "Найди всех участников проекта Восток из переписки, проверь их календари на следующую неделю, найди время когда все свободны, и отправь всем приглашение на встречу"

**Task breakdown:**

```
Root: "Организовать встречу команды проекта Восток"
├─ 1. "Найти всех участников проекта в переписке"
│   ├─ 1.1 "Выполнить RAG запрос: участники проекта Восток" ✓
│   └─ 1.2 "Извлечь email-адреса из результатов" ✓
├─ 2. "Проверить календари всех участников на след. неделю"
│   ├─ 2.1 "Получить доступ к календарям участников" ✓
│   └─ 2.2 "Извлечь занятость каждого участника" ✓
├─ 3. "Найти общее свободное время"
│   └─ 3.1 "Вычислить пересечение свободных слотов" ✓
└─ 4. "Создать событие и отправить приглашения"
    ├─ 4.1 "Создать событие в календаре" ✓
    └─ 4.2 "Отправить email-приглашения всем участникам" ✓
```

**Execution order:**
1. Task 1.1 → RAG query
2. Task 1.2 → Extract emails
3. Task 2.1 → Get calendar access
4. Task 2.2 → Extract availability
5. Task 3.1 → Find common time
6. Task 4.1 → Create event
7. Task 4.2 → Send invitations

**Final report:**
> "Я организовал встречу со всеми участниками проекта 'Восток'. Нашёл шесть участников: Иван Петров, Анна Смирнова, Пётр Сидоров, Марина Кузнецова, Сергей Волков и Ольга Николаева. Проверил их календари на следующую неделю (с тринадцатого по семнадцатое января) и нашёл общее свободное время: среда, пятнадцатого января, в четырнадцать ноль-ноль. Создал событие в календаре на два часа с темой 'Встреча команды проекта Восток' и отправил приглашения всем участникам. Все получат email с деталями встречи и ссылкой на календарное событие."

---

### Пример 2: Анализ и резюме проекта

**User request:**
> "Найди все письма о проекте Восток за последний месяц, создай встречу по каждой обсуждённой теме, и отправь участникам резюме"

**Task breakdown:**

```
Root: "Проанализировать переписку и организовать встречи"
├─ 1. "Найти все письма о проекте Восток за месяц"
│   └─ 1.1 "Выполнить RAG запрос" ✓
├─ 2. "Проанализировать и выделить темы"
│   ├─ 2.1 "Извлечь основные темы обсуждения" ✓
│   └─ 2.2 "Определить участников каждой темы" ✓
├─ 3. "Создать встречи по каждой теме"
│   ├─ 3.1 "Создать встречу: технические требования" ✓
│   ├─ 3.2 "Создать встречу: бюджет проекта" ✓
│   └─ 3.3 "Создать встречу: сроки запуска" ✓
└─ 4. "Отправить резюме участникам"
    └─ 4.1 "Сгенерировать и отправить email с резюме" ✓
```

---

## Интеграция с RealtimeAgent

### Добавление tool в агент

```typescript
// severstalAssistantAgent/index.ts

import { executeComplexTask } from './executeComplexTaskTool';

export const severstalAssistant = new RealtimeAgent({
  name: 'severstalAssistant',
  voice: 'sage',
  instructions: improvedRussianAssistantPrompt,
  tools: [
    hostedMcpTool(/* calendar/email */),
    lightragQueryTool,
    delegateToSupervisor,
    executeComplexTask,  // ← NEW: hierarchical task execution
  ],
});
```

### Обновление промпта

Добавить в `improvedPrompt.ts`:

```markdown
## Tool: executeComplexTask

**Используй для ОЧЕНЬ СЛОЖНЫХ задач (5+ независимых шагов):**

**Критерии:**
- ✅ Множественная координация между подзадачами
- ✅ Задача затрагивает множество людей (массовая рассылка)
- ✅ Массовые операции (10+ событий, писем)
- ✅ Сложный анализ с множественными источниками
- ✅ Условная логика и зависимости между шагами

**Примеры:**
- "Найди всех участников проекта, проверь календари, найди время, отправь приглашения"
- "Проанализируй все письма за месяц, создай встречи, отправь резюме"

**Preamble:**
«Это очень сложная задача, запускаю систему декомпозиции...»

**НЕ используй для:**
- ❌ Простые задачи (1-4 шага) → delegateToSupervisor
- ❌ Только RAG → lightrag_query
- ❌ Одиночные действия → MCP tools
```

---

## Мониторинг и отладка

### Progress Callbacks

```typescript
const orchestrator = new TaskOrchestrator(
  { enableProgressCallbacks: true },
  (update) => {
    console.log(`[Progress] ${update.type}:`, update.taskDescription);
    console.log(`[Progress] ${update.progress}% completed`);

    // Можно отправлять в UI через WebSocket:
    // ws.send(JSON.stringify(update));
  }
);
```

### Логирование

Все операции логируются с префиксом `[TaskOrchestrator]`:

```
[TaskOrchestrator] Starting complex task execution: Найди всех участников...
[TaskOrchestrator] Requesting breakdown for task task-root
[TaskOrchestrator] Breaking down task task-root into 4 subtasks
[TaskOrchestrator] Task breakdown complete: totalLeafTasks=7
[TaskOrchestrator] Executing task task-root.0.0: Выполнить RAG запрос
[TaskOrchestrator] Task task-root.0.0 completed successfully
...
[TaskOrchestrator] Task execution complete: completed=7, failed=0
```

### Визуализация дерева задач

```typescript
import { formatTaskTreeForDisplay } from './taskOrchestrator';

console.log(formatTaskTreeForDisplay(taskTree.rootTask));
```

Output:
```
✓ Организовать встречу команды проекта Восток
  → Я организовал встречу со всеми участниками...
  ✓ Найти всех участников проекта
    → Нашёл 6 участников: Иван, Анна, Пётр...
    ✓ Выполнить RAG запрос
      → Найдено 23 письма с упоминаниями участников
    ✓ Извлечь email-адреса
      → Извлечено 6 адресов
  ✓ Проверить календари
    ...
```

---

## Ограничения и оптимизация

### Ограничения

1. **Максимальная вложенность:** 5 уровней (configurable)
   - Предотвращает бесконечную рекурсию
   - Большинство задач укладывается в 2-3 уровня

2. **Максимум подзадач:** 10 на задачу (configurable)
   - Балансирует детализацию и производительность
   - Supervisor может группировать похожие действия

3. **Последовательное выполнение:** Задачи выполняются одна за другой
   - Упрощает управление зависимостями
   - В будущем можно добавить параллельное выполнение независимых задач

4. **Время выполнения:** Очень сложные задачи могут занять минуты
   - Supervisor вызывается несколько раз (breakdown + execution + report)
   - Realtime user experience может страдать

### Оптимизации

**1. Кэширование breakdown результатов:**
```typescript
// Если похожая задача уже разбивалась, использовать кэш
const cachedBreakdown = breakdownCache.get(taskSignature);
```

**2. Параллельное выполнение независимых задач:**
```typescript
// Задачи без зависимостей друг от друга можно выполнять параллельно
await Promise.all([
  executeTask(task1),
  executeTask(task2),
  executeTask(task3),
]);
```

**3. Ранняя остановка:**
```typescript
// Если критическая задача провалилась, остановить выполнение
if (task.isCritical && task.status === 'failed') {
  throw new Error('Critical task failed, stopping execution');
}
```

**4. Streaming results:**
```typescript
// Отправлять промежуточные результаты пользователю в реальном времени
orchestrator.on('task_completed', (task) => {
  realtimeAgent.speak(`Выполнено: ${task.description}`);
});
```

---

## Дальнейшее развитие

### Планируемые улучшения

1. **Поддержка параллелизма**
   - Выполнение независимых задач одновременно
   - Значительно ускорит выполнение

2. **Retry mechanism**
   - Автоматический retry при временных ошибках
   - Exponential backoff

3. **Task prioritization**
   - Критические задачи выполняются первыми
   - Некритичные можно пропустить при ошибках

4. **Persistense & resume**
   - Сохранение состояния TaskTree в DB
   - Возможность продолжить выполнение после перезапуска

5. **UI для отображения прогресса**
   - Визуализация дерева задач
   - Real-time progress bars
   - Интерактивное управление (pause/resume/cancel)

6. **Adaptive breakdown**
   - ML-модель для предсказания оптимального разбиения
   - Обучение на успешных выполнениях

---

## Заключение

Система иерархического выполнения задач решает проблему **ОЧЕНЬ СЛОЖНЫХ multi-step задач**, которые не могут быть эффективно выполнены в один запрос к supervisor.

**Ключевые преимущества:**
- ✅ Автоматическое рекурсивное разбиение
- ✅ Поддержка вложенности до 5 уровней
- ✅ Учёт зависимостей между задачами
- ✅ Иерархический сбор результатов
- ✅ Детальный финальный отчёт
- ✅ Прозрачность выполнения (логи, callbacks)

**Когда использовать:**
- 5+ независимых шагов
- Множественная координация
- Массовые операции
- Сложный анализ

**Когда НЕ использовать:**
- Простые задачи (1-4 шага) → `delegateToSupervisor`
- Только RAG запрос → `lightrag_query`
- Одиночные действия → MCP tools напрямую

---

**Готово!** 🎉

Система готова к использованию. Следующий шаг - интеграция с RealtimeAgent и тестирование на реальных сложных задачах.
