# Логика работы Project Agent

## Обзор

Project Agent — специализированный Realtime Agent для управления проектами в мультиагентной системе SeverstalAssistant. Агент обрабатывает запросы пользователей на создание, обновление и получение информации о проектах через пошаговые сценарии (мастер) и прямые операции.

## Архитектура

### Интеграция в систему

- **Тип**: Frontend RealtimeAgent (gpt-4o-realtime-mini)
- **Голос**: `alloy`
- **Родительский агент**: Router Agent (через handoff)
- **Расположение**: `src/app/agentConfigs/severstalAssistantAgent/agents/projectAgent.ts`

### Механизм handoff

Агент вызывается Router Agent'ом через механизм handoff. После завершения работы автоматически возвращает управление Router Agent'у.

```typescript
projectAgent.handoffs = [routerAgent]
```

## Инструменты (Tools)

Агент использует два типа инструментов:

### 1. Project Wizard (пошаговый мастер)

**Файл**: `src/app/agentConfigs/severstalAssistantAgent/tools/projects/projectWizardTools.ts`

**Назначение**: Интерактивный мастер для пошагового сбора данных и выполнения операций.

**Режимы работы**:
- `create` — создание нового проекта
- `update_status` — обновление статуса проекта
- `get_info` — получение информации о проекте

**Параметры**:
- `mode` — режим мастера
- `userId` — ID пользователя
- `currentQuestion` — номер текущего вопроса (строка)
- `userResponse` — ответ пользователя
- `state` — накопленное состояние (name, description, manager, team, status, project_id)

**Логика работы**:

#### Режим `create`

1. Определяет последовательность шагов:
   - Шаг 1: название проекта (name)
   - Шаг 2: описание (description)
   - Шаг 3: руководитель (manager)
   - Шаг 4: команда (team)
   - Шаг 5: статус (status)

2. Применяет ответ пользователя к следующему незаполненному полю (игнорирует `currentQuestion`, определяет следующий шаг по состоянию).

3. Валидация:
   - Название обязательно, минимум 2 символа
   - Проверка на существование проекта с таким названием

4. Создание проекта через MCP `create_project`.

5. Возвращает результат:
   - `status: 'completed'` — успех
   - `status: 'error'` — ошибка
   - `status: 'in_progress'` — продолжение диалога

#### Режим `update_status`

1. Шаг 1: запрос названия проекта
2. Шаг 2: запрос нового статуса
3. Поиск проекта по названию через MCP `get_project`
4. Обновление поля `status` через MCP `update_project_field`
5. Возврат результата

#### Режим `get_info`

1. Шаг 1: запрос названия проекта
2. Поиск проекта через MCP `get_project`
3. Возврат информации о проекте

### 2. Базовые операции MCP

**Файл**: `src/app/agentConfigs/severstalAssistantAgent/tools/projectTools.ts`

Все инструменты являются обёртками над MCP-клиентом (`src/app/lib/projectsMcpClient.ts`).

#### `getProjectByName`
- Получение проекта по названию
- Параметры: `name`, `userId`
- Возвращает проект или сообщение "Project not found"

#### `createProject`
- Создание проекта
- Параметры: `userId`, `name` (обязательно), `manager`, `team`, `description`, `status` (опционально)
- Возвращает ID созданного проекта

#### `updateProject`
- Полное/частичное обновление проекта
- Параметры: `userId`, `project_id` (обязательно), остальные опционально
- Обновляет все переданные поля

#### `updateProjectField`
- Обновление одного поля проекта
- Параметры: `userId`, `project_id`, `field`, `value`
- Используется для точечных обновлений (например, только статус)

#### `deleteProject`
- Удаление проекта
- Параметры: `userId`, `project_id`
- Возвращает успех или сообщение "Project not found"

#### `searchProjects`
- Поиск проектов по полю
- Параметры: `userId`, `field`, `search_term`
- Возвращает массив найденных проектов

#### `getAllProjects`
- Получение всех проектов с пагинацией
- Параметры: `userId`, `skip` (по умолчанию 0), `limit` (по умолчанию 100)
- Возвращает список проектов

## Промпт агента

**Файл**: `src/app/agentConfigs/severstalAssistantAgent/prompts/projectPrompt.ts`

### Основные задачи

1. Добавить проект (мастер с уточняющими вопросами)
2. Обновить статус проекта
3. Показать информацию и статус проекта

### Правила работы

- При запросе "Хочу добавить проект" → запуск `projectWizard` в режиме `create`
- При запросе "Обнови статус проект(а) …" → запуск `projectWizard` в режиме `update_status`
  - Если не хватает данных (имя/статус) → задавать уточняющие вопросы
- При запросе "Покажи проект …" или "Статус проекта …" → использование `projectWizard` в режиме `get_info`
- Тон: дружелюбный, деловой
- Подход: пошагово, один вопрос за раз
- При завершении мастера → подтверждение результата (ID, название, статус)
- Форматирование: кратко и структурированно
- Если MCP возвращает "Project not found" → предложить создать проект или уточнить имя

## Взаимодействие с бэкендом

### MCP Client

**Файл**: `src/app/lib/projectsMcpClient.ts`

**Endpoint**: `${PROJECTS_MCP_BASE_URL}/api/v1/mcp/call`

**MCP Tools**:
- `get_project` — получение проекта по названию
- `create_project` — создание проекта
- `update_project` — обновление проекта
- `update_project_field` — обновление поля
- `delete_project` — удаление проекта
- `search_projects` — поиск проектов
- `get_all_projects` — получение всех проектов

**Особенности**:
- Все запросы требуют `userId` для трассировки
- Таймаут запросов: 30 секунд (по умолчанию)
- Обработка ошибок: возврат `null` или `false` при сбоях

## Потоки работы (Workflows)

### 1. Создание проекта

```
Пользователь: "Хочу добавить проект"
  ↓
Агент: запускает projectWizard(mode: 'create')
  ↓
Шаг 1: "Как назвать проект?"
  ↓
Пользователь: [название]
  ↓
Шаг 2: "Коротко опишите проект"
  ↓
Пользователь: [описание]
  ↓
Шаг 3: "Кто руководитель проекта?"
  ↓
Пользователь: [руководитель]
  ↓
Шаг 4: "Какая команда участвует?"
  ↓
Пользователь: [команда]
  ↓
Шаг 5: "Какой статус поставить?"
  ↓
Пользователь: [статус]
  ↓
Валидация → Проверка на дубликат → MCP create_project
  ↓
Результат: подтверждение с ID, названием, статусом
```

### 2. Обновление статуса

```
Пользователь: "Обнови статус проекта X"
  ↓
Агент: запускает projectWizard(mode: 'update_status')
  ↓
Шаг 1: "Как называется проект?" (если не указано)
  ↓
Пользователь: [название]
  ↓
Шаг 2: "На какой статус обновить?"
  ↓
Пользователь: [новый статус]
  ↓
MCP get_project → MCP update_project_field
  ↓
Результат: подтверждение обновления
```

### 3. Получение информации

```
Пользователь: "Покажи проект X" / "Статус проекта X"
  ↓
Агент: запускает projectWizard(mode: 'get_info')
  ↓
Шаг 1: "Введите название проекта" (если не указано)
  ↓
Пользователь: [название]
  ↓
MCP get_project
  ↓
Результат: информация о проекте или ошибка "не найден"
```

## Состояние мастера (State)

Мастер использует объект состояния для накопления данных между шагами:

```typescript
{
  name?: string;
  description?: string;
  manager?: string;
  team?: string;
  status?: string;
  project_id?: string;  // используется в update_status после поиска
}
```

Состояние передаётся между вызовами мастера и сохраняется в контексте диалога.

## Обработка ошибок

### В мастере

- **Проект не найден**: возврат `status: 'error'` с предложением уточнить название или создать проект
- **Проект уже существует**: возврат ошибки с предложением уточнить название
- **Ошибка MCP**: возврат `status: 'error'` с сообщением об ошибке
- **Валидация**: возврат к соответствующему шагу с сообщением об ошибке

### В базовых операциях

- **Проект не найден**: возврат `{ success: true, message: "Project not found" }`
- **Ошибка создания/обновления**: возврат `{ success: false, error: '...' }`
- **Исключения**: логирование и возврат `null`/`false`

## Особенности реализации

### Устойчивость мастера create

Мастер в режиме `create` определяет следующий шаг по состоянию, а не по `currentQuestion`. Это позволяет:
- Пропускать уже заполненные поля
- Корректно обрабатывать повторные вызовы
- Устойчиво работать при частично заполненном состоянии

### Валидация названия

- Обязательное поле
- Минимум 2 символа
- Проверка на дубликаты перед созданием

### Возврат управления

После завершения работы агент автоматически возвращает управление Router Agent'у через механизм handoff.

## Зависимости

- `@openai/agents/realtime` — RealtimeAgent
- `@/app/lib/projectsMcpClient` — MCP клиент для проектов
- Router Agent — для получения управления

## Точки расширения

При изменении логики работы агента следует учитывать:

1. **Добавление новых режимов мастера** — расширить `WizardMode` и добавить соответствующий case в `projectWizard`
2. **Изменение последовательности шагов** — модифицировать массив `steps` в режиме `create`
3. **Новые поля проекта** — добавить в `state` и в соответствующие MCP-инструменты
4. **Дополнительная валидация** — расширить блоки валидации в мастере
5. **Новые операции** — добавить инструменты в массив `tools` агента

