# Архитектура декомпозиции SeverstalAssistant - Краткое резюме

## Проблема

**Текущий монолитный агент:**
- 733 строки промпта
- 11 инструментов
- Все сценарии в одном агенте
- Когнитивная перегрузка модели

## Решение

**Специализированная мультиагентная архитектура:**
- 1 Router Agent + 5 специализированных агентов
- 100-150 строк промпта на агента
- Автоматическое переключение через handoffs
- Четкие границы ответственности

---

## Архитектура агентов

```
                    ┌─────────────────────────────┐
                    │      Router Agent           │
                    │  (Маршрутизация запросов)   │
                    └─────────────┬───────────────┘
                                  │
            ┌─────────────────────┼─────────────────────┐
            │                     │                     │
            ▼                     ▼                     ▼
    ┌──────────────┐      ┌──────────────┐     ┌──────────────┐
    │ Email Agent  │      │Calendar Agent│     │Knowledge Agent│
    │              │      │              │     │              │
    │• Чтение      │      │• Просмотр    │     │• RAG поиск   │
    │• Отправка    │      │• Создание    │     │• История     │
    │              │      │              │     │• Документы   │
    └──────────────┘      └──────────────┘     └──────────────┘
            │                     │                     │
            └─────────────────────┼─────────────────────┘
                                  │
            ┌─────────────────────┼─────────────────────┐
            │                     │                     │
            ▼                     ▼                     ▼
    ┌──────────────┐      ┌──────────────┐     ┌──────────────┐
    │Planning Agent│      │Interview Agent│    │Complex Task  │
    │  (tool)      │      │              │     │Agent (tool)  │
    │• 2-7 шагов   │      │• Персонализ. │     │• 8+ шагов    │
    │• Логика      │      │• Опрос       │     │• Массовые    │
    │• gpt-4       │      │• Профиль     │     │• Долгие      │
    └──────────────┘      └──────────────┘     └──────────────┘
```

---

## Специализированные агенты

### 1. Router Agent (главный)

**Роль:** Маршрутизатор запросов

**Функции:**
- Определяет намерение пользователя
- Делегирует специализированным агентам
- Координирует работу
- Возвращает контроль после выполнения

**Промпт:** ~150 строк

**Инструменты:**
- `getCurrentUserInfo`
- `checkInterviewStatus`
- `delegateToPlanningAgent` (tool)
- `delegateToComplexTaskAgent` (tool)

**Handoffs:** Email, Calendar, Knowledge, Interview Agents

---

### 2. Email Agent

**Роль:** Специалист по email

**Функции:**
- ✅ Чтение писем
- ✅ Отправка писем (с подтверждением)
- ❌ НЕ: поиск по содержимому (→ Knowledge Agent)

**Промпт:** ~120 строк

**Инструменты:**
- Email MCP (read, send)

**Примеры:**
```
User: «Прочитай последнее письмо»
Email Agent: «Открываю почту» → [reads] → «Последнее письмо от Ивана...»

User: «Отправь письмо Анне»
Email Agent: Собирает параметры → Подтверждает → Отправляет
```

---

### 3. Calendar Agent

**Роль:** Специалист по календарю

**Функции:**
- ✅ Просмотр расписания
- ✅ Создание событий (с подтверждением)
- ❌ НЕ: поиск свободного времени (→ Planning Agent)

**Промпт:** ~120 строк

**Инструменты:**
- Calendar MCP (get_events, create_event)

**Примеры:**
```
User: «Покажи встречи на завтра»
Calendar Agent: «Смотрю календарь» → [reads] → «На завтра три встречи...»

User: «Создай встречу с Иваном завтра в 15:00»
Calendar Agent: Собирает тему → Подтверждает → Создаёт
```

---

### 4. Knowledge Agent

**Роль:** Специалист по поиску знаний

**Функции:**
- ✅ RAG поиск в базе знаний
- ✅ Исторический контекст
- ✅ Поиск в документах, заметках
- ❌ НЕ: чтение конкретных недавних писем (→ Email Agent)

**Промпт:** ~130 строк

**Инструменты:**
- `lightrag_query`
- `lightrag_query_data`
- `lightrag_track_status`
- `lightrag_get_pipeline_status`

**Примеры:**
```
User: «Что писали о проекте Восток?»
Knowledge Agent: «Ищу в документах» → [RAG query] → «Нашла пять обсуждений...»

User: «Когда в последний раз говорили о бюджете?»
Knowledge Agent: [searches] → «Последнее обсуждение двадцатого января»
```

---

### 5. Planning Agent (tool-based)

**Роль:** Многошаговые задачи с логикой

**Функции:**
- ✅ 2-7 шагов с зависимостями
- ✅ Условная логика
- ✅ Анализ и координация
- ✅ Backend supervisor (gpt-4)

**Реализация:** Tool (не RealtimeAgent)

**Параметры:**
- `conversationContext`
- `proposedPlan`
- `userIntent`
- `complexity`

**Примеры:**
```
User: «Прочитай письмо от Анны и назначь встречу»
Router: «Секундочку, уточню детали» → [calls tool]
Planning: [Анализ] → «Анна предлагает встречу завтра в 15:00...»
```

---

### 6. Interview Agent

**Роль:** Персонализация пользователя

**Функции:**
- ✅ Проверка статуса интервью
- ✅ Проведение опроса (4 + 3 вопроса)
- ✅ Сохранение в профиль

**Промпт:** ~110 строк

**Инструменты:**
- `getCurrentUserInfo`
- `checkInterviewStatus`
- `startInitialInterview`
- `conductInitialInterview`

**Триггер:** Новый пользователь (интервью не пройдено)

**Примеры:**
```
[Новый пользователь]
Interview Agent: «Могу провести краткий опрос на 3-5 минут?»
→ 4 обязательных вопроса
→ 3 опциональных вопроса
→ Сохранение
→ «Спасибо! Предпочтения сохранены»
```

---

### 7. Complex Task Agent (tool-based)

**Роль:** Очень сложные массовые операции

**Функции:**
- ✅ 8+ шагов
- ✅ Массовые операции (множество людей)
- ✅ Долгое выполнение (несколько минут)
- ⚠️ Требует подтверждения пользователя

**Реализация:** Tool (не RealtimeAgent)

**Параметры:**
- `taskDescription` (полное описание)
- `conversationContext`

**Примеры:**
```
User: «Найди всех участников проекта, проверь календари, отправь приглашения»
Router: «Это очень сложная задача, может занять несколько минут. Продолжить?»
User: «Да»
Router: [calls tool] → «Работаю над задачей...»
[Через несколько минут]
Complex Task: «Готово! Нашёл 8 участников, создал встречу...»
```

---

## Механизм делегирования

### Handoffs (Автоматическое переключение)

**Как работает:**

```typescript
const routerAgent = new RealtimeAgent({
  name: 'routerAgent',
  handoffs: [emailAgent, calendarAgent, knowledgeAgent, interviewAgent],
  instructions: routerAgentPrompt,
});
```

**Поток:**

```
User: "Прочитай письмо"
    ↓
Router Agent (SDK анализирует handoffDescription)
    ↓
Email Agent (автоматическое переключение)
    ↓
Email Agent выполняет задачу
    ↓
Email Agent завершает (exit criteria)
    ↓
Router Agent (автоматический возврат)
```

**Преимущества:**
- ✅ Автоматическое определение агента
- ✅ Плавные переходы
- ✅ Сохранение контекста
- ✅ Автоматический возврат

---

### Tool-based Delegation (Явное)

**Для Planning и Complex Task Agents:**

```typescript
export const delegateToPlanningAgent = tool({
  name: 'delegateToPlanningAgent',
  description: 'Многошаговые задачи (2-7 шагов)',
  parameters: z.object({
    conversationContext: z.string(),
    proposedPlan: z.string(),
    userIntent: z.string(),
    complexity: z.enum(['high', 'medium', 'low']),
  }),
  execute: async (params) => {
    // Backend API call to gpt-4 supervisor
    const response = await fetch('/api/supervisor', {
      method: 'POST',
      body: JSON.stringify(params),
    });
    return (await response.json()).nextResponse;
  },
});
```

**Поток:**

```
User: "Прочитай письмо и создай встречу"
    ↓
Router Agent: «Секундочку, уточню детали»
    ↓
[Вызов delegateToPlanningAgent]
    ↓
Backend Supervisor (gpt-4) анализирует
    ↓
Возврат nextResponse
    ↓
Router Agent использует ответ ДОСЛОВНО
```

**Преимущества:**
- ✅ Более умная модель (gpt-4)
- ✅ Сложная логика и рассуждения
- ✅ Контроль над параметрами
- ✅ Backend обработка

---

## Возврат в Router Agent

### Автоматический возврат (Handoffs)

**Exit Criteria в промпте каждого агента:**

```typescript
`
## Exit Criteria

После успешного выполнения задачи:
- Сообщить пользователю результат
- Автоматически вернуться к главному агенту
- НЕ задавать новые вопросы вне своей области

Примеры:
- «Письмо отправлено. Чем ещё помочь?»
- «Встреча создана. Что-то ещё?»
`
```

**SDK автоматически:**
- Определяет завершение задачи
- Возвращает контроль Router Agent
- Сохраняет всю историю разговора

### Эскалация (при выходе за рамки)

**В промпте специализированного агента:**

```typescript
`
## Escalation Rules

Если запрос выходит за рамки вашей области:
- Признать ограничение: «Это не моя область»
- Передать обратно: «Передаю основному помощнику»
`
```

---

## Примеры полных диалогов

### Пример 1: Простое чтение email

```
User: «Прочитай последнее письмо»
    ↓
Router Agent [handoff → Email Agent]
    ↓
Email Agent: «Открываю почту»
Email Agent: [calls read_latest_email]
Email Agent: «Последнее письмо от Ивана с темой "Встреча"...»
    ↓
[Exit criteria: задача выполнена]
    ↓
Router Agent [автоматический возврат]
    ↓
Router Agent: [готов к следующему запросу]
```

---

### Пример 2: Многошаговая задача

```
User: «Прочитай письмо от Анны и назначь встречу»
    ↓
Router Agent: «Секундочку, уточню детали»
Router Agent: [calls delegateToPlanningAgent tool]
    ↓
Backend Planning Agent (gpt-4):
  - Читает письмо через Email MCP
  - Извлекает предложенное время
  - Формирует nextResponse
    ↓
Router Agent: «Анна предлагает встречу завтра в 15:00. Какую тему указать?»
    ↓
User: «Обсуждение проекта»
    ↓
Router Agent: [re-delegates to Planning Agent]
    ↓
Planning Agent: Создаёт событие
    ↓
Router Agent: «Встреча создана. Готово!»
```

---

### Пример 3: Переключение между агентами

```
User: «Покажи письма от Анны»
    ↓
Router Agent [handoff → Email Agent]
    ↓
Email Agent: «Открываю почту»
Email Agent: «Нашла три письма от Анны за последнюю неделю»
    ↓
[Возврат в Router Agent]
    ↓
User: «А что она писала о проекте Восток?»
    ↓
Router Agent [handoff → Knowledge Agent]
    ↓
Knowledge Agent: «Ищу в документах»
Knowledge Agent: [RAG query]
Knowledge Agent: «В переписке с Анной о проекте Восток нашла три обсуждения...»
    ↓
[Возврат в Router Agent]
    ↓
User: «Назначь встречу с ней»
    ↓
Router Agent: [calls delegateToPlanningAgent]
    ↓
Planning Agent: «Когда удобно: понедельник, среду или пятницу?»
...
```

---

## Сравнение: До и После

### До (Монолитный агент)

```
┌─────────────────────────────────────────┐
│      severstalAssistant                 │
│                                         │
│  Промпт: 733 строки                     │
│  Инструменты: 11 tools                  │
│  Сценарии: ВСЕ в одном агенте           │
│                                         │
│  Проблемы:                              │
│  ❌ Когнитивная перегрузка              │
│  ❌ Конфликтующие инструкции            │
│  ❌ Сложность поддержки                 │
│  ❌ Неоптимальное использование контекста│
└─────────────────────────────────────────┘
```

### После (Мультиагентная архитектура)

```
┌─────────────────────────────────────────┐
│      Router Agent (150 строк)           │
│      + 5 специализированных агентов     │
└────────────────┬────────────────────────┘
                 │
    ┌────────────┼────────────┐
    │            │            │
    ▼            ▼            ▼
┌────────┐  ┌────────┐  ┌────────┐
│Email   │  │Calendar│  │Knowledge│
│120 стр.│  │120 стр.│  │130 стр.│
└────────┘  └────────┘  └────────┘

  Преимущества:
  ✅ Фокусированные промпты
  ✅ Четкие границы ответственности
  ✅ Легкая поддержка и тестирование
  ✅ Оптимальное использование контекста
  ✅ Масштабируемость
```

---

## Метрики успеха

### Производительность

- **Размер промпта:** 733 строки → 100-150 строк на агента (↓ 80%)
- **Когнитивная нагрузка:** Высокая → Низкая
- **Скорость ответа:** Ожидается улучшение на 20-30%

### Качество

- **Точность маршрутизации:** Целевая метрика 95%+
- **Успешность выполнения:** Ожидается улучшение на 15-25%
- **Удовлетворённость пользователей:** Мониторинг обратной связи

### Разработка

- **Время на добавление нового агента:** 1-2 дня
- **Покрытие тестами:** Целевая метрика 80%+
- **Скорость локализации ошибок:** Ожидается улучшение на 50%

---

## План миграции (кратко)

### Этап 1: Подготовка (1-2 дня)
- Создать структуру файлов
- Извлечь промпты из монолитного агента

### Этап 2: Реализация агентов (2-3 дня)
- Email Agent
- Calendar Agent
- Knowledge Agent
- Interview Agent
- Planning Agent (tool)
- Complex Task Agent (tool)

### Этап 3: Router Agent (1 день)
- Промпт Router Agent
- Конфигурация handoffs
- Интеграция tools

### Этап 4: Тестирование (2-3 дня)
- Unit тесты
- Интеграционные тесты
- E2E тесты

### Этап 5: Деплой (1 день)
- Feature flag
- Канареечный деплой (10% пользователей)
- Мониторинг метрик

### Этап 6: Итерация (ongoing)
- Анализ логов
- Оптимизация промптов
- Добавление новых агентов

**Общее время:** 7-10 дней

---

## Рекомендации

### 1. Начать с минимального набора

**MVP:**
- Router Agent
- Email Agent
- Calendar Agent
- Planning Agent (tool)

**Затем добавить:**
- Knowledge Agent
- Interview Agent
- Complex Task Agent

### 2. Использовать feature flags

```typescript
const USE_MULTI_AGENT = process.env.NEXT_PUBLIC_USE_MULTI_AGENT === 'true';

export const severstalAssistant = USE_MULTI_AGENT
  ? routerAgent
  : severstalAssistantLegacy;
```

### 3. Логировать все handoffs

```typescript
console.log('[Handoff]', {
  from: 'routerAgent',
  to: 'emailAgent',
  reason: 'email read request',
  timestamp: Date.now(),
});
```

### 4. Мониторить метрики

- Количество handoffs
- Успешность делегирования
- Время выполнения задач
- Ошибки и эскалации

### 5. Документировать каждого агента

- Область ответственности
- Примеры диалогов
- Edge cases
- Exit criteria

---

## Заключение

### Ключевые решения

1. **6 агентов:** Router + 5 специализированных
2. **Handoffs:** Автоматическое переключение через SDK
3. **Tool-based:** Явное делегирование для Planning и Complex Task
4. **Exit criteria:** Четкие правила возврата
5. **Промпты:** 100-150 строк вместо 733

### Результаты

- ✅ ↓ 80% размер промпта на агента
- ✅ ↑ Качество ответов
- ✅ ↑ Скорость разработки
- ✅ ↑ Тестируемость
- ✅ ↑ Масштабируемость

### Следующие шаги

1. Создать структуру файлов
2. Извлечь промпты
3. Реализовать Router Agent
4. Тестирование
5. Канареечный деплой
6. Мониторинг

**Детальная документация:** [agent-decomposition-architecture.md](./agent-decomposition-architecture.md)
