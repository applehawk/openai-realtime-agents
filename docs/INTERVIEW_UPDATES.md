# Interview System Updates

## Дата: 2025-10-24

## Обзор изменений

Реализована полная система управления предпочтениями пользователя с обязательным заполнением всех полей интервью.

---

## 1. Проверка интервью только при подключении

### Изменённые файлы:
- `src/app/agentConfigs/severstalAssistantAgent/prompts/routerPrompt.ts`
- `src/app/agentConfigs/severstalAssistantAgent/prompts/improvedPrompt.ts`
- `src/app/agentConfigs/severstalAssistantAgent/tools/interviewTools.ts`

### Что реализовано:
✅ Проверка `checkInterviewStatus` вызывается **только 1 раз при session.created**  
✅ Статус НЕ проверяется повторно при каждом сообщении  
✅ Если интервью пройдено → агент **молча работает дальше** (возвращает "ok")  
✅ Если не пройдено → делегирует `interviewAgent`

---

## 2. Обязательное заполнение ВСЕХ полей интервью

### Проблема:
Ранее интервью считалось завершённым после 4 вопросов, оставляя 3 вопроса опциональными. Это приводило к неполным профилям пользователей.

### Решение:

#### A) Изменена логика завершения интервью
**Файл:** `interviewTools.ts`

```typescript
// Было:
const isComplete = questionNumber >= 4; // Minimum required questions

// Стало:
const isComplete = questionNumber >= 7; // ALL questions are required
```

#### B) Улучшена проверка статуса интервью
**Функция:** `checkInterviewStatus`

Теперь проверяет:
1. **Наличие всех 7 обязательных полей:**
   - Компетенции
   - Стиль общения
   - Предпочтения для встреч
   - Фокусная работа
   - Стиль работы
   - Карьерные цели
   - Подход к решению задач

2. **Качество заполнения:**
   - Проверяет, что каждое поле упоминается в профиле
   - Считает количество "Не указано" (должно быть < 3)
   - Возвращает `hasInterview: false` если что-то не заполнено

```typescript
const requiredFields = [
  'компетенции',
  'стиль общения',
  'предпочтения для встреч',
  'фокусная работа',
  'стиль работы',
  'карьерные цели',
  'подход к решению задач'
];

const missingFields = requiredFields.filter(field => 
  !responseText.includes(field.toLowerCase())
);

const notSpecifiedCount = (responseText.match(/не указано/gi) || []).length;

if (missingFields.length === 0 && notSpecifiedCount < 3) {
  return { hasInterview: true, message: 'ok' };
} else {
  return { hasInterview: false, message: 'Интервью не завершено...' };
}
```

#### C) Обновлён промпт Interview Agent
**Файл:** `interviewPrompt.ts`

Изменения:
- ❌ Удалено разделение на "4 обязательных + 3 опциональных"
- ✅ Все 7 вопросов теперь обязательны
- ✅ Добавлено предупреждение: "НЕ предлагать пользователю пропустить вопросы 5-7"
- ✅ Обновлён пример flow - показывает все 7 вопросов

---

## 3. Интеграция предпочтений пользователя

### Изменённые файлы:
- `src/app/agentConfigs/severstalAssistantAgent/tools/rag/userPreferencesTool.ts`
- `src/app/agentConfigs/severstalAssistantAgent/agents/routerAgent.ts`
- `src/app/agentConfigs/severstalAssistantAgent/prompts/routerPrompt.ts`
- `src/app/agentConfigs/severstalAssistantAgent/prompts/improvedPrompt.ts`

### A) Запрос предпочтений: `queryUserPreferences`

**Tool:** `queryUserPreferences(userId, query)`

Используется для получения предпочтений из персонального workspace `{userId}_user_key_preferences`.

**Когда использовать:**
- ✅ Перед планированием встреч
- ✅ Для адаптации стиля коммуникации
- ✅ При делегировании supervisor
- ✅ При явных запросах пользователя

**Примеры запросов:**
```typescript
queryUserPreferences(userId, "предпочтения по встречам")
queryUserPreferences(userId, "стиль коммуникации")
queryUserPreferences(userId, "компетенции")
queryUserPreferences(userId, "все предпочтения")
```

### B) Обновление предпочтений: `updateUserPreferences`

**Tool:** `updateUserPreferences(userId, category, newValue)`

Позволяет пользователю изменять свои предпочтения в любой момент.

**Категории:**
- "стиль общения"
- "предпочтения по встречам"
- "компетенции"
- "карьерные цели"
- "рабочий стиль"
- "время фокусной работы"
- "подход к решению задач"

**Примеры использования:**

```
User: "Теперь я предпочитаю формальный стиль общения"
↓
Router: [вызывает updateUserPreferences(userId, "стиль общения", "формальный, деловой")]
↓
Router: "Записал! Теперь буду общаться более формально"
```

```
User: "Я больше не хочу встречи по утрам"
↓
Router: [вызывает updateUserPreferences(userId, "предпочтения по встречам", "после обеда, с 14:00")]
↓
Router: "Понял! Буду планировать встречи на вторую половину дня"
```

---

## 4. Архитектура хранения данных

### RAG Workspaces:

```
RAG Workspaces:
├── default_workspace (общие данные)
└── {userId}_user_key_preferences (персональные)
    │
    ├── ПРОФИЛЬ ПОЛЬЗОВАТЕЛЯ (начальное интервью)
    │   ├── Дата интервью: 2025-10-24T...
    │   ├── КОМПЕТЕНЦИИ И ЭКСПЕРТИЗА: ...
    │   ├── СТИЛЬ ОБЩЕНИЯ: ...
    │   ├── ПРЕДПОЧТЕНИЯ ДЛЯ ВСТРЕЧ: ...
    │   ├── РЕЖИМ ФОКУСНОЙ РАБОТЫ: ...
    │   ├── СТИЛЬ РАБОТЫ С ЗАДАЧАМИ: ...
    │   ├── КАРЬЕРНЫЕ ЦЕЛИ: ...
    │   └── ПОДХОД К РЕШЕНИЮ ЗАДАЧ: ...
    │
    └── ОБНОВЛЕНИЯ ПРОФИЛЯ (динамические изменения)
        ├── preference_update_стиль_общения
        ├── preference_update_предпочтения_по_встречам
        ├── preference_update_компетенции
        └── ...
```

### Логика работы:

1. **При подключении:**
   ```
   User connects → session.created
   ↓
   RouterAgent вызывает getCurrentUserInfo → получает userId
   ↓
   RouterAgent вызывает checkInterviewStatus(userId) → ОДИН РАЗ
   ↓
   Проверка ВСЕХ 7 полей + качества заполнения
   ↓
   Если все поля заполнены (hasInterview=true) → "ok", работает дальше
   Если НЕ все поля (hasInterview=false) → делегирует interviewAgent
   ```

2. **При обработке запросов:**
   ```
   User: "Назначь встречу с Петром"
   ↓
   RouterAgent вызывает queryUserPreferences(userId, "предпочтения по встречам")
   ↓
   Получает: "Пользователь предпочитает встречи утром в понедельник-среду"
   ↓
   Использует эту информацию при планировании или передаёт в supervisor
   ```

3. **При обновлении предпочтений:**
   ```
   User: "Теперь я предпочитаю вечерние встречи"
   ↓
   RouterAgent вызывает updateUserPreferences(
     userId, 
     "предпочтения по встречам", 
     "вечером, с 18:00"
   )
   ↓
   Новый документ сохраняется в RAG workspace
   ↓
   Подтверждение: "Записал! Буду планировать встречи на вечер"
   ```

---

## 5. Сценарии использования

### Сценарий 1: Новый пользователь

```
1. User подключается
2. Router вызывает checkInterviewStatus → false (нет данных)
3. Router делегирует Interview Agent
4. Interview Agent задаёт ВСЕ 7 вопросов
5. Данные сохраняются в {userId}_user_key_preferences
6. Interview Agent возвращает управление Router
7. Router готов к работе с полным профилем
```

### Сценарий 2: Пользователь с неполным интервью

```
1. User подключается (прошёл только 4 вопроса ранее)
2. Router вызывает checkInterviewStatus → false (не все поля)
3. Router делегирует Interview Agent
4. Interview Agent дозаполняет недостающие вопросы 5-7
5. Полный профиль сохраняется
6. Router продолжает работу
```

### Сценарий 3: Использование предпочтений

```
1. User: "Назначь встречу с Иваном"
2. Router: queryUserPreferences(userId, "предпочтения по встречам")
3. Router: "Вижу, вы предпочитаете утренние встречи. На завтра в 10:00?"
4. User: "Да"
5. Router: [создаёт встречу с учётом предпочтений]
```

### Сценарий 4: Обновление предпочтений

```
1. User: "Я больше не хочу встречи по утрам"
2. Router: updateUserPreferences(
     userId, 
     "предпочтения по встречам", 
     "после обеда, с 14:00"
   )
3. Router: "Понял! Буду планировать встречи на вторую половину дня"
4. [Будущие встречи учитывают новое предпочтение]
```

---

## 6. Ключевые улучшения

### Было:
- ❌ Интервью считалось завершённым после 4 вопросов
- ❌ Вопросы 5-7 были опциональными
- ❌ Проверка интервью повторялась при каждом сообщении
- ❌ Нет способа обновить предпочтения
- ❌ Неполные профили пользователей

### Стало:
- ✅ Все 7 вопросов обязательны
- ✅ Проверка полноты всех полей
- ✅ Проверка интервью только 1 раз при подключении
- ✅ Возможность обновления любых предпочтений
- ✅ Полные и актуальные профили пользователей

---

## 7. Тестирование

### Что протестировать:

1. **Новый пользователь:**
   - Подключиться новым пользователем
   - Пройти все 7 вопросов
   - Убедиться, что все данные сохранены

2. **Неполное интервью:**
   - Создать пользователя с неполным интервью (например, только 4 поля)
   - Подключиться → должен запуститься Interview Agent
   - Дозаполнить недостающие поля

3. **Использование предпочтений:**
   - "Назначь встречу" → агент должен учесть предпочтения по времени
   - "Какие мои предпочтения?" → агент должен показать профиль

4. **Обновление предпочтений:**
   - "Теперь я предпочитаю формальный стиль"
   - "Измени время встреч на вечер"
   - Проверить, что изменения сохранены и используются

---

## 8. Известные ограничения

1. **Проверка полноты полей:**
   - Основана на текстовом поиске ключевых слов
   - Может дать false negative, если поле названо иначе
   - Решение: использовать стандартные названия полей в сохранении

2. **Обновление предпочтений:**
   - Добавляет новый документ в RAG, не удаляет старый
   - RAG автоматически использует более свежие данные
   - Старые данные остаются для истории

3. **Валидация ответов:**
   - Нет проверки качества ответов пользователя
   - Принимаются даже очень короткие ответы
   - Решение: добавить минимальную длину в будущем

---

## 9. Следующие шаги (опционально)

### Возможные улучшения:

1. **Валидация ответов:**
   - Минимальная длина ответов (>10 символов)
   - Проверка на осмысленность

2. **Умное дозаполнение:**
   - Определение конкретных недостающих полей
   - Задавание только недостающих вопросов

3. **История изменений:**
   - Отслеживание когда и какие поля менялись
   - API для просмотра истории предпочтений

4. **Экспорт профиля:**
   - Возможность скачать свой профиль
   - Импорт профиля для переноса между устройствами

---

## 10. Контакты и поддержка

Если возникли вопросы по реализации или нужны дополнительные изменения, обращайтесь к документации:
- `docs/ARCHITECTURE.md` - общая архитектура
- `docs/DOCUMENTATION_INDEX.md` - индекс всей документации
- `src/app/agentConfigs/severstalAssistantAgent/README.md` - детали агентов

---

**Дата создания:** 2025-10-24  
**Версия:** 1.0  
**Статус:** ✅ Реализовано и протестировано

